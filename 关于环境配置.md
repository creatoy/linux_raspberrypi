# 环境配置参考

[环境搭建教程](https://readthedocs-demo1.readthedocs.io/zh-cn/latest/R4L.html)

> NOTE: 我这里使用的编辑器是 VSCode，并安装了 rust-analyzer 和 clangd 插件。系统中还需要安装 clangd 和 python3

## 关于代码提示

### Rust 侧

运行以下命令生成 rust-project.json 文件

```sh
make ARCH=arm64 LLVM=1 O=build_4b rust-analyzer
```

> NOTE: 教程中构建内核时使用的 make 命令都带有 O=build_4b 选项，这会导致内核编译时的目标文件都被放入 build_4b 目录中。又由于 rust-analyzer 的 [BUG](https://github.com/rust-lang/rust-analyzer/issues/17040) 导致 rust-analyzer 无法正确引入 bindgen 生成在 build_4b 下的 rust 文件，所以最好将 O=build_4b 选项去掉，否则 binding 的结构和函数都会无法跳转。

> 如果删去了 O=build_4b 选项，注意要重新运行以下命令:  
> ```sh
> make ARCH=arm64 LLVM=1 bcm2711_rust_defconfig
> make ARCH=arm64 LLVM=1 -j$(nproc)
> make ARCH=arm64 LLVM=1 rust-analyzer
> ```

> 在我的机器上完成上面的步骤后，VSCode 的 rust-analyzer 插件提示缺少 sysroot，这里我的解决方法是在 rust-project.json 文件中添加 sysroot 的路径。
> 具体操作是将最后一行的 "sysroot_src": "path_to_sysroot/lib/rustlib/src/rust/library", 复制一行并替换为 "sysroot": "path_to_sysroot"，形式如下：
> ```json
> "sysroot_src": "/home/xxx/.rustup/toolchains/1.73.0-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library",
> "sysroot": "/home/xxx/.rustup/toolchains/1.73.0-x86_64-unknown-linux-gnu"
> ```

> 另外也有同学反映上面这个问题是因为生成的 rust-project.json 文件版本和 VSCode 的 rust-analyzer 插件的版本不匹配，导致提示错误。解决方法是本地安装 rust-analyzer 并配置 VSCode 使用本地安装的可执行文件。
> 具体操作方法是使用 rustup component add rust-analyzer 安装 rust-analyzer，然后在 settings.json 文件中添加以下内容：
> ```json
> {
>     "rust-analyzer.server.path": "~/.rustup/toolchains/1.73.0-x86_64-unknown-linux-gnu/bin/rust-analyzer",
> }

### C 侧
运行下面的命令生成 compile_commands.json 文件

```sh
python scripts/clang-tools/gen_compile_commands.py -d build_4b
```

> NOTE:如果上面将 O=build_4b 选项去掉了，这里也需要将 -d build_4b 选项去掉。

## 关于调试

在不涉及硬件操作的开发初期，可以使用 QEMU 模拟器进行程序调试。

> NOTE: 很多人觉得使用 GDB/LLDB 调试内核可能不太容易，这里只介绍一下如何使用 QEMU 和 GDB/LLDB 调试内核。 

1. 开启内核调试信息

在内核配置文件中添加以下选项以根据你的工具链生成调试信息:

```sh
CONFIG_DEBUG_INFO_DWARF_TOOLCHAIN_DEFAULT=y
```

2. 重新构建内核

3. 添加 .vscode/launch.json 文件配置 VSCode 中的 LLDB 调试功能，内容如下:

```sh
{
    "version": "0.2.0",
    "configurations": [
        {
            "type": "lldb",
            "request": "custom",
            "name": "Kernel debug (LLDB)",
            "targetCreateCommands": [
                "target create ${workspaceFolder}/vmlinux"
            ],
            "processCreateCommands": [
                "gdb-remote localhost:1234",
                "b start_kernel",
                "c"
            ]
        },
    ]
}
```

4. 修改 QEMU 启动脚本 boot.sh，在 qemu-system-aarch64 下面添加一行 `$@ \` 以接受外部传入的参数
```sh
...
qemu-system-aarch64 \
    $@ \
...
```
5. 运行 boot.sh -S -s 启动 QEMU，QEMU 将等待 LLDB 连接。此时从 VSCode 中启动 LLDB 调试器，就可以进行调试了。